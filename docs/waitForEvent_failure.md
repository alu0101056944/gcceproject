# Some notes done when reading `playwright`'s code on github

`waitForEvent` tells the waiter of playwright to make a `setTimeout` promise and enqueue it as a failure promise along with a `dispose()` to cancel the promise that once fulfilled will throw a `TimeoutError`. The waiter has a `waitForPromise()` that when called it races the enqueued failure promises, and if any failure promise wins then it catches and rethrows an error after calling it's `dispose()` to call all the dispose functions it has stored, which will cancel all the failure promises and I suppose other non failure promises if there are any stored for some reason.

So, because a `waitForEvent` starts that process, then **another object will have to call waiter's `dispose()` before any failure promise ends**, including the timeout failure promise. It simply calls all the `dispose` it has stored.

Then, after setting up the `TimeoutError` and errors from when the page is closed or when the page crashes, it calls a `waitForEvent` which receives an event emitter, a string for the event name and a predicate, which is checked if true by passing the argument dispatched by the event. And it creates both a promise and a dispose function for that promise, the first simply adds to the event emitter a new listener for the specific event, which when called it either resolves the promise or rejects the promise (if error in case of the later) depending on the event's dispatch argument. The dispose function simply removes that event listener from the event emitter. The event emitter is the page object. Once created the promise and the dispose, the `waitForPromise` is called, and because the dispose has been passed to it, then when the promise is resolved it then calls the dispose function and returns the value of the promise, and on the other hand, if the promise is rejected, then it also call the dispose but throws the error instead of returning the value obtained.

So basically waitForEvent uses promises, and there are try catchs but they rethrow, so the waitForEvent can be wrapped in a try catch and everything should be fine.
